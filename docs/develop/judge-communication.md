# 网站与评测机之间的通信协议

网站部分与评测机部分在设计时便分离了开来，因此咱们可以动态地调整评测机的数量。

## 建立 WebSocket 信道

分为两种方式，第一种是网站主动向评测机发起连接，适用于网站部署在内网的情况。这种情况下可以通过网站的前端 UI 界面填入评测机的 ip 地址和端口号，然后建立连接。

第二种情况是评测机主动向网站发起连接，这时需要在启动评测机的时候指定好网站的服务器 ip 地址和端口，之后再启动评测机进程。

## 通讯协议

假设网站和评测机之间建立好了稳定的 WebSocket 信道，接着就需要按照以下的通讯协议来进行通信。

无论是网站还是评测机发送信息，都必须使用 JSON 格式编码所有参数。对方在收到 JSON 格式的信息后，直接使用 JSON.parse() 函数来解析原来的数据。
允许实现采用其它兼容JSON的序列化方式，推荐CBOR。

### 握手~~与身份认证~~
当连接启动后，发起连接者需要在服务器的请求下，呈递自己的身份。
~~目前支持PSK（共享密钥）验证方式~~，以后可能会添加公钥-私钥验证。

目前考虑到可以走wireguard，暂时不提供密码学验证。

当前协议版本为 `v0` 。如果协议不匹配，则返回错误信息，并断开连接。

连接后，客户端发送以下消息。

```json
{
  "type": "hello",
  "version" : "v0"
}
```

如果版本匹配且可以连接，则重复这一消息，否则发送一条错误消息。

### 特性表示

```json
{
    "type" : "feature",
    "cpus" : 16,
    "langs" : ["c","cpp","rust","python","go"],
    "ext-features" : []
}
```

评测机在连接后，需要发送特性表示。

### ~~网站广播目前有待领取的任务~~

```json
{
  "type": "mission"
}
```

### ~~评测机回复可以领取评测任务~~

当评测机受到来自网站广播的待领取任务数据包时，检查自身是否有空余的计算资源。

如果自身有空余的计算资源，则返回一个可以领取的任务数据包，否则什么也不返回。

```json
{
  "type": "mission"
}
```

### 网站分配任务给评测机（直接分配）

//当网站收到来自评测机的回复之后，立即检查当前是否有待领取的评测任务。

网站当有任务需要执行时，选择一个评测机（这个选择方法由实现定义），向其推送任务。网站直接向评测机发送任务。评测机需要在超时限制之内返回以下响应之一：开始评测、获取数据、拒绝评测。如果没有回应，则视为评测机已经崩溃，将移出评测机列表中。如果当前评测机不能接受评测，则向下一台发送请求。如果所有评测机都不能接受请求，则等待一段时间后重新发送。

```json
{
  "type": "task",
  "id": 114514, // 评测的 id
  "code": "print(\"Hello, World!\")", // 评测的代码
  "language": "py", // 评测的语言
  "files": {
    // 所有数据文件的 uuid
    "config.json": "92ef12a1-5c81-4e54-a00c-b0ac49a73b2e",
    "1.in": "e584a209-0c9e-4fbc-b113-559f0aa13f9d",
    "1.out": "bc3337aa-10c4-4054-8aee-782a5ef2da85"
  }
}
```

在接收到开始评测的消息后，网站启动一个计时器，如果在测试点总计运行时间+两分钟之后依然没有收到来自评测机的评测结束数据包，则将该任务认定为评测超时，并丢弃之后关于该任务 id 的所有数据包。

### 评测机请求同步数据

当评测机收到来自网站分配的任务之后，检查自身是否有空余的计算资源或者是否能进行排队。

如果没有空余的计算资源，则返回一个[评测机拒绝评测][]数据包，否则将资源标记为占用，并且立刻开始同步数据。

评测机首先检查自身缓存中是否有目标文件，如果有，则直接使用这个缓存，否则向网站发送请求同步的数据包。

```json
{
  "type": "sync",
  "uuid": "92ef12a1-5c81-4e54-a00c-b0ac49a73b2e"
}
```

之后评测机启动一个计时器，如果在指明超时之后（如 1min）仍然没有收到来自网站同步的数据，则将该数据标记为丢失，取消接下来的评测，并且直接返回评测失败。

### 网站返回同步数据

当网站收到来自评测机的同步数据请求之后，从数据库中读取相应的文件，并且以 base64 形式返回数据。
对于MIME类型，建议至少区分文本text/plain与二进制流。

考虑中：对于简单文本，不作b 64 编码。

```json
{
  "type": "sync",
  "uuid": "92ef12a1-5c81-4e54-a00c-b0ac49a73b2e",
  "mime": "text/plain",
  "data": "MTE0NTE0MTkxOTgxMA=="
}
```

### 评测机拒绝评测

如果评测机当前没有空余的计算资源却还被网站分配了任务，则返回一个拒绝评测的数据包。

```json
{
  "type": "reject",
  "id": 114514
}
```

当网站收到该数据包之后应该将这个 id 对应的任务提交给其它机器。

### 评测机同步任务进度

每当评测机评测取得进度时（具体包括：数据同步结束，编译结束，任意数据点运行结束等），都应该发送一个进度数据包给网站。
每一个数据点完成时，只返回当前点的结果。

需要确定状态指示用词。

```json
{
  "type": "progress",
  "id": 114514,
  "status": "Running",
  "message" : "Compiling",
  "log": "compile warnings ...",
  "subtasks": [
    {
      "status": "Accepted",
      "tasks": [
        {
          "status": "Accepted",
          "time": 0,
          "memory": 114514,
          "message": "4 numbers correct"
        }
      ]
    },
    {
      "status": "Running",
      "tasks": [
        {
          "status": "Running",
          "time": -1,
          "memory": -1,
          "message": ""
        }
      ]
    },
    {
      "status": "Pending",
      "tasks": [
        {
          "status": "Pending",
          "time": -1,
          "memory": -1,
          "message": ""
        }
      ]
    }
  ]
}
```

### 评测结束

当评测机评测结束之后返回一个评测结束数据包。
状态码需要确定。

```json
{
  "type": "finish",
  "id": 114514,
  "status": "Wrong Answer",
  "message": "compile warnings ...",
  "subtasks": [
    {
      "status": "Accepted",
      "tasks": [
        {
          "status": "Accepted",
          "time": 0,
          "memory": 121299,
          "message": "4 numbers correct"
        }
      ]
    },
    {
      "status": "Wrong Answer",
      "tasks": [
        {
          "status": "Wrong Answer",
          "time": 1,
          "memory": 122999,
          "message": "line 1: find 2, expected 3"
        }
      ]
    },
    {
      "status": "Accepted",
      "tasks": [
        {
          "status": "Accepted",
          "time": 20,
          "memory": 203023,
          "message": "1299 numbers correct"
        }
      ]
    }
  ]
}
```

当网站收到该数据包之后应该将这个 id 对应的任务标记为已完成，并且将这个任务的结果写入数据库，之后丢弃所有与该 id 对应的任务的所有同步进度数据包。



### 网站询问状态

网站想跟评测机打乒乓球。

```json
{
  "type": "ping"
}
```

### 评测机回应状态

只要评测机收到来自网站的乒乓球，就打回去。

```json
{
  "type": "pong"
}
```

目前，暂不需要实现网站回应 ping 请求。

### 评测机状态推送

评测机允许向网站指示其状态或者设置，可用于网站选择评测机。
```json
{
  "type":"status",
  "status":"ok",
  "cpus":"4",
}
```
当前，可以指示评测机进入和退出拥挤/繁忙状态。

### 错误报告

```json
{
  "type":"error",
  "code":"VersionMismatch",
  "msg":"Message"
}
```
这一结构体表示发生了无法预料的错误，如果必要，可以关闭连接。

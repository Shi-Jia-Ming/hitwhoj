# 网站与评测机之间的通信协议

网站部分与评测机部分在设计时便分离了开来，因此咱们可以动态地调整评测机的数量。

## 数据类型

### TaskStatus 测试点结果状态

| 状态名                | 说明                                                                      |
| --------------------- | ------------------------------------------------------------------------- |
| Pending               | 测试点还在排队                                                            |
| Running               | 测试点正在运行                                                            |
| Skipped               | 子任务中出现第一个非 Accepted 测试点之后，剩余的所有测试点都直接跳过      |
| Accepted              | 程序通过该测试点                                                          |
| Wrong Answer          | 程序正常运行结束，但是输出的结果与标准结果不匹配，或者无法通过 SPJ 的校验 |
| Time Limit Exceeded   | 程序无法在规定的时间限制内运行结束                                        |
| Memory Limit Exceeded | 程序运行过程中超过内存限制，或者因为超过运行内存而终止                    |
| Runtime Error         | 程序运行过程中出现其他非正常终止状况，或者程序运行结束返回值不为 0        |
| System Error          | 评测遇到非预期的情况                                                      |

### SubtaskStatus 子任务结果状态

| 状态名                | 说明                                                   |
| --------------------- | ------------------------------------------------------ |
| Pending               | 子任务还在排队（没有进行任何编译或者运行）             |
| Running               | 子任务中的其中一个测试点正在运行                       |
| Accepted              | 程序通过子任务中的全部测试点                           |
| Wrong Answer          | 第一个非 Accepted 测试点的状态为 Wrong Answer          |
| Time Limit Exceeded   | 第一个非 Accepted 测试点的状态为 Time Limit Exceeded   |
| Memory Limit Exceeded | 第一个非 Accepted 测试点的状态为 Memory Limit Exceeded |
| Runtime Error         | 第一个非 Accepted 测试点的状态为 Runtime Error         |
| System Error          | 评测遇到非预期的情况                                   |

### JudgeStatus 评测结果状态

| 状态名                | 说明                                                       |
| --------------------- | ---------------------------------------------------------- |
| Pending               | 任务还在排队                                               |
| Judging               | 任务已经被成功分配给了评测机                               |
| Compiling             | 任务正在编译                                               |
| Running               | 任务正在运行                                               |
| Compile Error         | 程序编译时遇到了错误                                       |
| Accepted              | 程序通过全部子任务                                         |
| Wrong Answer          | 程序第一个非 Accepted 子任务的结果为 Wrong Answer          |
| Time Limit Exceeded   | 程序第一个非 Accepted 子任务的结果为 Time Limit Exceeded   |
| Memory Limit Exceeded | 程序第一个非 Accepted 子任务的结果为 Memory Limit Exceeded |
| Runtime Error         | 程序第一个非 Accepted 子任务的结果为 Runtime Error         |
| System Error          | 评测遇到非预期的情况                                       |

### TaskResult 测试点评测结果

| 字段    | 类型       | 说明                                           |
| ------- | ---------- | ---------------------------------------------- |
| message | string     | SPJ 输出的内容。对于非 SPJ 评测，它应为 null。 |
| status  | TaskStatus | 测试点的状态                                   |
| time    | int        | 运行时间，单位为 ms，如果没有结果则为 -1       |
| memory  | int        | 内存使用量，单位为 byte，如果没有结果则为 -1   |

### SubtaskResult 子任务评测结果

| 字段    | 类型          | 说明           |
| ------- | ------------- | -------------- |
| message | string        | 子任务说明内容 |
| status  | SubtaskStatus | 子任务状态     |
| score   | int           | 子任务得分     |
| tasks   | TaskResult[]  | 所有测试点结果 |

### JudgeResult 评测结果

| 字段     | 类型            | 说明                                             |
| -------- | --------------- | ------------------------------------------------ |
| message  | string          | 编译器的输出内容                                 |
| status   | JudgeStatus     | 评测状态                                         |
| score    | int             | 评测机得分，等于所有 Accepted 子任务的得分总和。 |
| subtasks | SubtaskResult[] | 所有子任务结果                                   |

### Language 字段：编程语言及其代号

| 编程语言 | 代号 |
| -------- | ---- |
| C        | c    |
| C++      | cpp  |
| Python 3 | py   |
| Rust     | rust |
| Go       | go   |
| Java     | java |

注意如果 status 为 `Pending`, `Judging`, `Compiling`, `Compile Error` 的话，subtasks 字段应当为一个空数组。其余情况下 subtasks 字段在全部完成时，应当为 `config.json` 中指定的所有测试点的信息，否则为更新的测试点的信息。

## 建立 WebSocket 信道

首先网站必须能够主动访问到评测机，如果评测机处于内网中，或者通过公网进行传输时，可以通过 [WireGuard](https://www.wireguard.com/) 技术来提供内网穿透和加密信道的功能。由于 WireGuard 本身自带加密通信协议，因此网站和评测机之间目前不再进行密码学加密工作。

WebSocket 连接的建立统一由网站进行，系统管理员可以在网站上面通过图形界面手动填写评测机的 ip 地址和端口号，然后点击添加按钮，即可建立连接。也可以随时关闭评测机。

## 通讯协议

在网站和评测机之间建立好了稳定的信道后，接着就需要按照以下的通讯协议来进行通信。

需要注意的是，无论是网站还是评测机发送信息，都必须使用 JSON 格式编码所有数据。对方在收到 JSON 格式的信息后，直接使用 JSON.parse() 函数（或者使用 serde_json 的相关函数）来解析回原来的数据。数据中的 type 字段可以用来分辨数据包的类型。

**一个方向的连接上只能有一个没有被响应的请求。**也就是说，在一个请求没有被响应之前，不能再发出新的请求。

对于流水化请求及乱序响应，可能在后续版本中实现，或通过扩展特性集表示。

### 握手与版本确认

当连接启动后，**评测机**需要向**网站**声明自己的版本号信息。

```json
{
  "type": "hello",
  "version": "v0", // 评测机当前协议版本
  "cpus": 16, // 评测机支持的最大进程数量
  // 评测机支持的语言类型
  "langs": ["c", "cpp", "rust", "python", "go"],
  // 评测机支持的其它特性，当前版本暂时没有具体功能
  "ext-features": []
}
```

当前协议版本为 `v0`。如果**网站**发现对方与自身的协议版本不匹配，则返回错误信息，并断开连接。

### 评测机通知网站当前状态

评测机需要定时发送该类型数据包通知网站目前评测机的状态信息。

```json
{
  "type": "status",
  "cpus": 16, // 最大并发任务数量
  "occupied": 4, // 当前正在执行的任务数量
  "queue": 0 // 队列中等待的评测任务数量
}
```

网站本身也会维护一份评测机当前的任务状态，当收到该数据包时，便覆盖自身维护的评测机状态信息。

### 网站分配任务给评测机（直接分配）

调度方式由网站定义。以下是本实现中使用的方案：

网站首先会将所有的评测机按照可用语言分成若干各子集，对于每个子集维护最后调度的评测机序号。假设网站从任务队列中取出了第一个需要分配的任务，则网站先筛选出该任务提交语言对应的评测机子集，接着从维护的最后调度评测机序号开始，依次查找第一个可用的评测机（即当前正在执行的任务数量小于最大并发任务数量）。如果找了一圈也没有发现可用的评测机，则将任务放回到队列的末端，等待下一轮分配的时候再决策。

当网站确认要将任务分配给某评测机之后，网站会向其推送分配任务数据包。

```json
{
  "type": "task",
  "id": 114514, // 评测的 id，在一定的合理时间范围内不会重复
  "code": "print(\"Hello, World!\")", // 评测的代码
  "language": "py", // 评测的语言
  // 所有数据文件的 UUID，可以根据 UUID 来获取文件的内容
  "files": {
    "config.json": "92ef12a1-5c81-4e54-a00c-b0ac49a73b2e",
    "1.in": "e584a209-0c9e-4fbc-b113-559f0aa13f9d",
    "1.out": "bc3337aa-10c4-4054-8aee-782a5ef2da85"
  }
}
```

网站发送完该数据包之后启动一个计时器，如果评测机在时间范围内没有响应「同意评测」、或者「拒绝评测」的任意一个数据包，则网站将该任务重新放回到队列的尾端，并且**强制中断**与该评测机的连接。

如果评测机拒绝评测，则网站将继续询问下一个评测机。

当评测机确定开始进行评测之后，网站会更新本地的评测机状态数据，并且开始一个新的计时器，如果评测机在时间范围内没有返回「评测结束」消息，则判定为评测超时，将[结果状态](#结果状态)置为 `System Error`，并且**强制中断**与该评测机之间的连接。

### 评测机同意

如果评测机同意执行被分配的任务，则返回一个同意数据包。

```json
{
  "type": "accept",
  "id": 114514
}
```

### 评测机拒绝

如果评测机拒绝执行被分配的任务，则返回一个拒绝数据包。

```json
{
  "type": "reject",
  "id": 114514
}
```

### 评测机请求同步数据

评测机一旦确认开始评测，则需要先同步所有的数据文件。

评测机首先检查自身缓存中是否有目标文件。如果有，则直接使用这个缓存；否则向网站发送请求同步的数据包。

```json
{
  "type": "sync",
  "uuid": "92ef12a1-5c81-4e54-a00c-b0ac49a73b2e"
}
```

之后评测机启动一个计时器，如果在超出时间范围之后仍然没有收到来自网站同步的数据，或者这一请求发生了错误，则将该数据标记为丢失，取消接下来的评测，并且直接返回评测失败 `System Error`。

### 网站返回同步数据

当网站收到来自评测机的同步数据请求之后，从数据库中读取相应的文件，并且以 base64 形式返回数据。

<span style="background-color:yellow">考虑中：对于简单文本，不作 base64 编码。对于 MIME 类型，建议至少区分文本 text/plain 与二进制流。</span><sup>必要性请求</sup>

```json
{
  "type": "sync",
  "uuid": "92ef12a1-5c81-4e54-a00c-b0ac49a73b2e",
  "data": "MTE0NTE0MTkxOTgxMA=="
}
```

### 评测机同步任务进度

每当评测机评测取得进度时（具体包括：数据同步结束，编译结束，任意数据点运行结束等），都应该发送一个进度数据包同步给网站。

进度包中包含当前评测结果的全量更新。

```json
{
  "type": "progress",
  "id": 114514,
  "result": <struct JudgeResult>
}
```

### 评测结束

当评测机评测结束之后返回一个评测结束数据包。

```json
{
  "type": "finish",
  "id": 114514,
  "result": <struct JudgeResult>
}
```

当网站收到该数据包之后应该将这个 id 对应的任务标记为已完成，并且将这个任务的结果写入数据库，之后丢弃所有与该 id 对应的任务的所有同步进度数据包。

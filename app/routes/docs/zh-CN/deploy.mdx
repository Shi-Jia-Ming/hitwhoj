---
meta:
  title: 部署 - HITwh OJ
---

# 部署

## 安装依赖

需要预先安装以下软件：

- [PostgreSQL][postgres]: 数据库，能运行就行
- [MinIO][minio]: 文件存储，能运行就行
- [Node.js][nodejs]: 需要 v16，其他版本未经测试

## 部署网站

```bash
git clone --depth=1 -b master git@git.hit.edu.cn:hitwhoj/hitwhoj.git
cd hitwhoj

# 安装依赖
yarn install
# 编译网站
yarn build
```

之后需要配置 `.env` 文件，具体如下：

```bash
# .env

# 数据库链接
DATABASE_URL=postgres://hitwhoj:hitwhoj@localhost:5432/hitwhoj

# MinIO 链接
S3_ENDPOINT=localhost
S3_PORT=9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=hitwhoj

# 网站配置
## 监听端口
PORT=8080
## 与评测机通信时的密钥
JUDGE_PRIVATE_KEY= # 随便什么
## 最大文件上传大小
MAX_FILE_SIZE=20000000 # 20MB
```

配置完成之后需要初始化数据库，具体如下：

```bash
# 初始化数据库
yarn prisma db push

# 如果您在开发模式，可以使用 Seed 来填充一些数据到数据库
yarn prisma db seed
```

## 启动网站

使用 `yarn start` 启动网站。

## 本地代理

如果您不打算使用 80/443 端口来开放网站，那么可以跳过这一段。

推荐使用 nginx 作为代理来监听 80/443 端口，再将流量转发到 8080 端口。

```conf
# /etc/nginx/nginx.conf

http {
  include       mime.types;
  default_type  application/octet-stream;

  sendfile           on;
  keepalive_timeout  65;

  server {
    listen       80;
    server_name  localhost;

    return 301 https://$host$request_uri;
  }

  server {
    listen       443 ssl;
    server_name  localhost_ssl;

    ssl_certificate      /path/to/fullchain.pem;
    ssl_certificate_key  /path/to/privkey.pem;

    location / {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_pass http://127.0.0.1:8080;
    }
  }
}
```

[postgres]: https://www.postgresql.org/
[minio]: https://min.io/
[nodejs]: https://nodejs.org/en/
